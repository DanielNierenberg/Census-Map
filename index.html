<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Huntsville Map - Interactive Buildings (Leaflet Only)</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet.draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <style>
        body { margin:0; padding:0; }
        #map { height: 100vh; }
    </style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Leaflet.draw JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
(async function() {
    // 1Ô∏è‚É£ Initialize map with Canvas renderer
    const map = L.map('map', { renderer: L.canvas(), preferCanvas: true }).setView([34.7304, -86.5861], 12);

    // 2Ô∏è‚É£ Base map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // 3Ô∏è‚É£ Block Groups
    const blockGroupsData = await fetch('Huntsville_Block_Groups.geojson').then(res => res.json());
    const blockGroupsLayer = L.geoJSON(blockGroupsData, {
        style: { color: 'black', weight: 1, fillOpacity: 0 }
    }).addTo(map);

    // 4Ô∏è‚É£ City boundary
    const cityBoundary = await fetch('Boundary_City_Huntsville_poly.geojson').then(res => res.json());
    const cityLayer = L.geoJSON(cityBoundary, {
        style: { color: 'orange', weight: 2, fillColor: 'orange', fillOpacity: 0.3 }
    }).addTo(map);
    map.fitBounds(cityLayer.getBounds());

    // 5Ô∏è‚É£ Load buildings into memory
    let allBuildings = [];
    async function loadBuildings(url) {
        const geojson = await fetch(url).then(r => r.json());
        allBuildings = allBuildings.concat(geojson.features);
    }
    await loadBuildings('Huntsville Residential Buildings Part1.geojson');
    await loadBuildings('Huntsville Residential Buildings Part2.geojson');
    await loadBuildings('OSMCombinedUnique_with_GEOIDFQ.geojson');

    const buildingsLayer = L.layerGroup().addTo(map);

    // 6Ô∏è‚É£ Function to display buildings intersecting a Leaflet shape
    function showBuildingsInPolygon(drawLayer) {
        buildingsLayer.clearLayers();
        const shapeBounds = drawLayer.getBounds();
        let count = 0;

        allBuildings.forEach(f => {
            if (!f.geometry || !f.geometry.coordinates) return;
            const coords = f.geometry.coordinates[0]; // assumes Polygon
            const latlngs = coords.map(c => [c[1], c[0]]);
            const buildingLayer = L.polygon(latlngs); // temp polygon for bounds check

            if (shapeBounds.intersects(buildingLayer.getBounds())) {
                const color = f.properties && f.properties.OSM ? 'darkred' : 'darkgreen';
                L.polygon(latlngs, { color: color, weight: 0.3, fillOpacity: 0.6, interactive: false }).addTo(buildingsLayer);
                count++;
            }
        });

        const center = drawLayer.getBounds().getCenter();
        L.popup()
         .setLatLng(center)
         .setContent(`<b>${count}</b> building(s) displayed`)
         .openOn(map);
    }

    // 7Ô∏è‚É£ Block group click
    blockGroupsLayer.eachLayer(layer => {
        layer.on('click', () => {
            showBuildingsInPolygon(layer);
        });
    });

    // 8Ô∏è‚É£ Leaflet.draw setup
    const drawControl = new L.Control.Draw({
        draw: {
            polyline: false,
            marker: false,
            circlemarker: false,
            polygon: true,
            rectangle: true,
            circle: true
        },
        edit: false
    });
    map.addControl(drawControl);

    map.on('draw:created', function(e) {
        const layer = e.layer;
        showBuildingsInPolygon(layer);
    });

    // 9Ô∏è‚É£ Clear button
    const clearButton = L.control({position: 'topright'});
    clearButton.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = '<a href="#" title="Clear Buildings" style="font-size:16px;line-height:24px;">üßπ</a>';
        div.style.backgroundColor = 'white';
        div.style.width = '34px';
        div.style.height = '34px';
        div.style.textAlign = 'center';
        div.style.cursor = 'pointer';
        div.onclick = function() {
            buildingsLayer.clearLayers();
        };
        return div;
    };
    clearButton.addTo(map);

})();
</script>
</body>
</html>
