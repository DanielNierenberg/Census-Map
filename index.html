<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Huntsville Map - Interactive Buildings</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

    <style>
        body { margin:0; padding:0; font-family: sans-serif; }
        #map { height: 100vh; }
        
        /* The UI box for status and counts */
        #status-panel {
            position: absolute;
            top: 10px;
            right: 50px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            min-width: 150px;
        }
        .loading { color: orange; font-weight: bold; }
        .ready { color: green; font-weight: bold; }
        .count-num { font-size: 1.2em; color: #007bff; display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="status-panel">
        <div id="load-status" class="loading">Status: Loading Data...</div>
        <div id="count-display">Buildings: 0</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script>
    (async function() {
        // 1Ô∏è‚É£ Initialize map
        const map = L.map('map', { 
            renderer: L.canvas(), 
            preferCanvas: true 
        }).setView([34.7304, -86.5861], 12);

        // 2Ô∏è‚É£ Base map (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Layers for organization
        const buildingsLayer = L.layerGroup().addTo(map);
        let allBuildings = [];

        // 3Ô∏è‚É£ Load Data
        try {
            // Load City Boundary
            const cityBoundary = await fetch('Boundary_City_Huntsville_poly.geojson').then(res => res.json());
            const cityLayer = L.geoJSON(cityBoundary, {
                style: { color: 'orange', weight: 2, fillColor: 'orange', fillOpacity: 0.1, interactive: false }
            }).addTo(map);
            map.fitBounds(cityLayer.getBounds());

            // Load Block Groups
            const blockGroupsData = await fetch('Huntsville_Block_Groups.geojson').then(res => res.json());
            L.geoJSON(blockGroupsData, {
                style: { color: 'black', weight: 0.5, fillOpacity: 0 },
                onEachFeature: (feature, layer) => {
                    layer.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        showBuildingsInPolygon(feature);
                    });
                }
            }).addTo(map);

            // Load Building Files
            const files = [
                'Huntsville Residential Buildings Part1.geojson',
                'Huntsville Residential Buildings Part2.geojson',
                'OSMCombinedUnique_with_GEOIDFQ.geojson'
            ];

            for (const file of files) {
                const data = await fetch(file).then(res => res.json());
                allBuildings = allBuildings.concat(data.features);
            }

            // Update Status to Ready
            document.getElementById('load-status').innerHTML = "Status: Ready ‚úÖ";
            document.getElementById('load-status').className = "ready";

        } catch (err) {
            document.getElementById('load-status').innerHTML = "Status: Error loading files";
            console.error(err);
        }

        // 4Ô∏è‚É£ The Calculation Engine (Optimized)
        function showBuildingsInPolygon(filterShape) {
            buildingsLayer.clearLayers();
            
            // Fast Pre-filter using Bounding Box
            const searchBbox = turf.bbox(filterShape);
            const searchBboxPoly = turf.bboxPolygon(searchBbox);

            const filtered = allBuildings.filter(building => {
                // Step 1: Quick math check (is it even in the neighborhood?)
                const bBbox = turf.bbox(building);
                const isNear = turf.booleanIntersects(searchBboxPoly, turf.bboxPolygon(bBbox));
                
                if (!isNear) return false;

                // Step 2: Precise check (does it touch the actual shape?)
                return turf.booleanIntersects(building, filterShape);
            });

            // Update the Count UI
            document.getElementById('count-display').innerHTML = `Buildings: <span class="count-num">${filtered.length.toLocaleString()}</span>`;

            // Render Results on Map as one single layer for speed
            if (filtered.length > 0) {
                L.geoJSON(filtered, {
                    interactive: false,
                    style: (f) => ({
                        color: f.properties?.OSM ? 'darkred' : 'darkgreen',
                        weight: 0.5,
                        fillOpacity: 0.7
                    })
                }).addTo(buildingsLayer);
            }
        }

        // 5Ô∏è‚É£ Drawing Tools Setup
        const drawControl = new L.Control.Draw({
            draw: {
                polyline: false, marker: false, circlemarker: false,
                polygon: true, rectangle: true, circle: true
            },
            edit: false
        });
        map.addControl(drawControl);

        map.on('draw:created', function(e) {
            const layer = e.layer;
            let shapeGeoJSON;

            if (layer instanceof L.Circle) {
                const center = layer.getLatLng();
                // Convert Leaflet circle to Turf polygon
                shapeGeoJSON = turf.circle([center.lng, center.lat], layer.getRadius()/1000, {units:'kilometers'});
            } else {
                shapeGeoJSON = layer.toGeoJSON();
            }

            showBuildingsInPolygon(shapeGeoJSON);
        });

        // 6Ô∏è‚É£ Clear Button
        const clearButton = L.control({position: 'topright'});
        clearButton.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            div.innerHTML = '<a href="#" title="Clear All" style="font-size:18px; text-decoration:none; background:white; width:34px; height:34px; display:flex; align-items:center; justify-content:center;">üßπ</a>';
            div.onclick = function(e) {
                e.preventDefault();
                buildingsLayer.clearLayers();
                document.getElementById('count-display').innerHTML = "Buildings: 0";
            };
            return div;
        };
        clearButton.addTo(map);

    })();
    </script>
</body>
</html>
