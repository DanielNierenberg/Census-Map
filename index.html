<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Huntsville ACS 2023 Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --dark-blue:#002f5d;
  --light-gray:#f4f7f6;
  --border-color:#ddd;
}
html,body {
  margin:0; padding:0; height:100%; width:100%;
  font-family:sans-serif;
  background:var(--light-gray);
  overflow:hidden;
}
#banner {
  height:5%;
  background:var(--dark-blue);
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
}
#banner h1 { font-size:1.2rem; margin:0; }

#main-container {
  height:95%;
  display:flex;
  padding:10px;
  gap:15px;
  box-sizing:border-box;
}

#map-container {
  flex:0 0 33%;
  position:relative;
  background:white;
  border-radius:8px;
  border:1px solid var(--border-color);
  overflow:hidden;
  transition:flex .3s;
}
#map-container.expanded { flex:0 0 100%; }

#map { height:100%; width:100%; }

#data-container {
  flex:1;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
}
#data-container.hidden { display:none; }

#search-panel {
  position:absolute;
  top:10px; left:50px;
  z-index:1000;
  background:white;
  padding:8px;
  width:220px;
  border-radius:4px;
  box-shadow:0 2px 5px rgba(0,0,0,.2);
}
#address-search { width:100%; padding:6px; }
#suggestions {
  list-style:none;
  margin:5px 0 0;
  padding:0;
  max-height:150px;
  overflow-y:auto;
  border:1px solid #eee;
  font-size:.8em;
}
#suggestions li {
  padding:6px;
  cursor:pointer;
}
#suggestions li:hover { background:#f0f0f0; }

.filter-row { display:flex; gap:10px; }
.filter-group { flex:1; }
.filter-group label {
  font-size:.7em;
  font-weight:bold;
  color:#555;
}

.kpi-row {
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:8px;
}
.kpi-card {
  background:white;
  border:1px solid var(--border-color);
  border-radius:6px;
  padding:8px;
  text-align:center;
}
.kpi-card .value { font-weight:bold; color:var(--dark-blue); }

.viz-row {
  display:flex;
  gap:10px;
  min-height:300px;
}
.table-container, .chart-container {
  flex:1;
  background:white;
  border-radius:6px;
  border:1px solid var(--border-color);
  padding:8px;
  overflow:auto;
}

table { width:100%; border-collapse:collapse; font-size:.75em; }
th { background:#f8f9fa; position:sticky; top:0; }
td,th { padding:6px; border-bottom:1px solid #eee; }

.info.legend {
  background:white;
  padding:10px;
  border-radius:5px;
  border:1px solid #ccc;
  font-size:.75em;
}
.info.legend i {
  width:18px;
  height:18px;
  float:left;
  margin-right:8px;
}
</style>
</head>

<body>
<div id="banner">
  <h1>Huntsville ACS 2023 5-year Block Group Data</h1>
</div>

<div id="main-container">
<div id="map-container">

  <div id="search-panel">
    <input id="address-search" placeholder="Type an address‚Ä¶" autocomplete="off">
    <ul id="suggestions"></ul>
  </div>

  <div id="map"></div>

  <div style="position:absolute;bottom:10px;left:10px;z-index:1000;background:white;padding:5px;border-radius:4px;font-size:.7em;border:1px solid #ccc">
    Res. Buildings (Selected):
    <span id="count-display" style="font-weight:bold">0</span>
  </div>
</div>

<div id="data-container">

<div class="filter-row">
  <div class="filter-group">
    <label>CATEGORY</label>
    <select id="category-select">
      <option value="">-- Select --</option>
      <option value="Computer/Internet Access">Computer/Internet Access</option>
      <option value="Employment">Employment</option>
      <option value="Ethnicity">Ethnicity</option>
      <option value="House-related">House-related</option>
      <option value="Language">Language</option>
      <option value="Population-related">Population-related</option>
      <option value="Transportation-related">Transportation-related</option>
    </select>
  </div>

  <div class="filter-group">
    <label>TABLE</label>
    <select id="table-select"><option>Select Category</option></select>
  </div>

  <div class="filter-group">
    <label>MAP LAYER</label>
    <select id="map-layer-select">
      <option value="default">Default Map</option>
    </select>
  </div>
</div>

<div class="kpi-row">
  <div class="kpi-card"><div>Total Population</div><div id="kpi-pop" class="value">0</div></div>
  <div class="kpi-card"><div>Total Households</div><div id="kpi-hh" class="value">0</div></div>
  <div class="kpi-card"><div>Median Income</div><div id="kpi-income" class="value">$0</div></div>
  <div class="kpi-card"><div>Median House Value</div><div id="kpi-house-val" class="value">$0</div></div>
  <div class="kpi-card"><div>Median Age</div><div id="kpi-age" class="value">0</div></div>
</div>

<div class="viz-row">
  <div class="table-container">
    <table id="data-table">
      <thead><tr><th>Parameter</th><th>Count (% of total)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="chart-container"><canvas id="barChart"></canvas></div>
</div>

</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
// ===================== MAP SETUP =====================
const map = L.map('map',{renderer:L.canvas()}).setView([34.7304,-86.5861],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- City boundary (FEATURE 1)
fetch('Boundary_City_Huntsville_poly.geojson')
.then(r=>r.json())
.then(d=>L.geoJSON(d,{
  style:{color:'orange',weight:2,fillOpacity:.1},
  interactive:false
}).addTo(map));

// Layers
const buildingsLayer = L.layerGroup().addTo(map);
const drawnItems = new L.FeatureGroup().addTo(map);

// --- Legend (FEATURE 2)
const legend = L.control({position:'bottomright'});

// --- Controls (FEATURE 4)
L.control({position:'topright'}).onAdd=()=>{
  const d=L.DomUtil.create('div','leaflet-bar');
  d.innerHTML='<a href="#">üè†</a>';
  d.onclick=e=>{e.preventDefault();map.setView([34.7304,-86.5861],12);}
  return d;
}.addTo(map);

// --- Expand
L.control({position:'topright'}).onAdd=()=>{
  const d=L.DomUtil.create('div','leaflet-bar');
  d.innerHTML='<a href="#">‚§¢</a>';
  d.onclick=e=>{
    e.preventDefault();
    document.getElementById('map-container').classList.toggle('expanded');
    document.getElementById('data-container').classList.toggle('hidden');
    setTimeout(()=>map.invalidateSize(),350);
  };
  return d;
}.addTo(map);

// --- Clear (FEATURE 5)
L.control({position:'topright'}).onAdd=()=>{
  const d=L.DomUtil.create('div','leaflet-bar');
  d.innerHTML='<a href="#">‚ùå</a>';
  d.onclick=e=>{
    e.preventDefault();
    drawnItems.clearLayers();
    buildingsLayer.clearLayers();
    if(currentMarker) map.removeLayer(currentMarker);
    activeBlockGroup=null;
    currentShape=null;
    document.getElementById('address-search').value='';
    document.getElementById('suggestions').innerHTML='';
    document.getElementById('map-layer-select').value='default';
    document.getElementById('count-display').innerText='0';
    legend.remove();
    updateMapLayer(); updateKPIs(); updateViz();
  };
  return d;
}.addTo(map);

// ===================== DATA =====================
let bgLayer, bgData, currentCSVData=[];
let allBuildings=[], allAddresses=[];
let activeBlockGroup=null, currentShape=null, currentMarker=null;
let chartInstance=null;

async function loadCSV(p){
  const t=await fetch(p).then(r=>r.text());
  return Papa.parse(t,{header:true,dynamicTyping:true}).data;
}

// --- Block groups
fetch('Huntsville_Block_Groups.geojson')
.then(r=>r.json())
.then(d=>{
  bgData=d;
  bgLayer=L.geoJSON(d,{
    style:{color:'black',weight:1,fillOpacity:0},
    onEachFeature:(f,l)=>{
      // --- Tooltip (FEATURE 3)
      l.bindTooltip(`GEOID: ${f.properties.GEOIDFQ}`);
      l.on('click',()=>{
        drawnItems.clearLayers();
        currentShape=null;
        activeBlockGroup=activeBlockGroup===f.properties.GEOIDFQ?null:f.properties.GEOIDFQ;
        updateMapLayer(); updateKPIs(); updateViz();
      });
    }
  }).addTo(map);
});

// ===================== DRAW =====================
map.addControl(new L.Control.Draw({
  draw:{polygon:true,rectangle:true,circle:true,polyline:false,marker:false,circlemarker:false},
  edit:false
}));

map.on('draw:created',e=>{
  drawnItems.clearLayers();
  drawnItems.addLayer(e.layer);
  activeBlockGroup=null;
  currentShape=e.layer instanceof L.Circle
    ? turf.circle([e.layer.getLatLng().lng,e.layer.getLatLng().lat],e.layer.getRadius()/1000,{units:'kilometers'})
    : e.layer.toGeoJSON();

  const hits=allBuildings.filter(b=>turf.booleanIntersects(b,currentShape));
  document.getElementById('count-display').innerText=hits.length;
  buildingsLayer.clearLayers();
  L.geoJSON(hits,{style:{color:'#ff00ff',fillOpacity:.7}}).addTo(buildingsLayer);
  updateMapLayer(); updateKPIs(); updateViz();
});

// ===================== SEARCH + RADIUS (FEATURE 6‚Äì9)
document.getElementById('address-search').addEventListener('input',function(){
  const q=this.value.toLowerCase();
  const s=document.getElementById('suggestions');
  s.innerHTML='';
  if(q.length<2) return;
  allAddresses.filter(a=>a.properties.Street_Address.toLowerCase().includes(q)).slice(0,10)
  .forEach(f=>{
    const li=document.createElement('li');
    li.textContent=f.properties.Street_Address;
    li.onclick=()=>{
      const coords=[f.geometry.coordinates[1],f.geometry.coordinates[0]];
      map.setView(coords,17);
      if(currentMarker) map.removeLayer(currentMarker);
      currentMarker=L.circleMarker(coords,{radius:10,color:'red'}).addTo(map);

      const popup=document.createElement('div');
      popup.innerHTML=`
        <strong>${f.properties.Street_Address}</strong><br>
        Radius (miles):
        <input id="rad" type="number" value="1" style="width:80%"><br>
        <button id="go">Submit</button>
      `;
      currentMarker.bindPopup(popup).openPopup();

      popup.querySelector('#go').onclick=()=>{
        const r=parseFloat(popup.querySelector('#rad').value)*1.60934;
        currentShape=turf.circle([f.geometry.coordinates[0],f.geometry.coordinates[1]],r,{units:'kilometers'});
        drawnItems.clearLayers();
        L.geoJSON(currentShape,{style:{color:'#3388ff',fillOpacity:.2}}).addTo(drawnItems);

        const hits=allBuildings.filter(b=>turf.booleanIntersects(b,currentShape));
        document.getElementById('count-display').innerText=hits.length;
        buildingsLayer.clearLayers();
        L.geoJSON(hits,{style:{color:'#ff00ff',fillOpacity:.7}}).addTo(buildingsLayer);

        // --- auto BG select (FEATURE 7)
        const pt=turf.point([f.geometry.coordinates[0],f.geometry.coordinates[1]]);
        const bg=bgData.features.find(b=>turf.booleanPointInPolygon(pt,b));
        if(bg) activeBlockGroup=bg.properties.GEOIDFQ;

        updateMapLayer(); updateKPIs(); updateViz();
        map.closePopup();
      };
    };
    s.appendChild(li);
  });
});

// ===================== LOAD BUILDINGS & ADDRESSES =====================
['p1','p2','p3','p4'].forEach(p=>{
  fetch(`1-9-26 Hun residential buildings with geoid ${p}.geojson`)
  .then(r=>r.json()).then(d=>allBuildings=allBuildings.concat(d.features));
});
['part1','part2'].forEach(p=>{
  fetch(`Street_Address_Inside_City_LatLon_${p}.geojson`)
  .then(r=>r.json()).then(d=>allAddresses=allAddresses.concat(d.features));
});

// ===================== MAP LAYER + LEGEND (FEATURE 2,10,11)
function updateMapLayer(){
  if(!bgLayer) return;
  const col=document.getElementById('map-layer-select').value;
  legend.remove();
  let max=0;
  if(col!=='default'&&currentCSVData.length)
    max=Math.max(...currentCSVData.map(r=>r[col]||0));

  bgLayer.eachLayer(l=>{
    const geoid=l.feature.properties.GEOIDFQ;
    const row=currentCSVData.find(r=>r.GEO_ID===geoid);
    let style={color:'black',weight:1,fillOpacity:0};
    if(col!=='default'){
      const v=row?.[col]||0;
      style.fill=true;
      style.fillColor='#4a148c';
      style.fillOpacity=max? (v/max)*.8:0;
    }
    if(activeBlockGroup===geoid){
      style.color='#FFFF00'; style.weight=4;
    }
    l.setStyle(style);
  });

  if(col!=='default'){
    legend.onAdd=()=>{
      const d=L.DomUtil.create('div','info legend');
      d.innerHTML=`<strong>${col}</strong><br>`;
      [0,max*.25,max*.5,max*.75].forEach(g=>{
        d.innerHTML+=`<i style="background:#4a148c;opacity:${g/max||.1}"></i>${Math.round(g)}+<br>`;
      });
      return d;
    };
    legend.addTo(map);
  }
}

// ===================== KPI / TABLE / CHART
// (UNCHANGED Code 2 logic ‚Äî omitted here ONLY because it was already validated above)
// KEEP YOUR EXISTING updateKPIs(), updateViz(), mappings, denominators EXACTLY AS BEFORE

</script>
</body>
</html>
