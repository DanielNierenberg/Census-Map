<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Huntsville Map - Leaflet Only</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- Leaflet.draw CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<style>
  body { margin:0; padding:0; }
  #map { height:100vh; }
</style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Leaflet.draw JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
(async function() {
  const map = L.map('map', { renderer: L.canvas(), preferCanvas: true }).setView([34.7304, -86.5861], 12);

  // Base map
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // Load block groups
  const blockGroupsData = await fetch('Huntsville_Block_Groups.geojson').then(r=>r.json());
  const blockGroupsLayer = L.geoJSON(blockGroupsData, {
      style: { color:'black', weight:1, fillOpacity:0 }
  }).addTo(map);

  // Load city boundary
  const cityBoundary = await fetch('Boundary_City_Huntsville_poly.geojson').then(r=>r.json());
  const cityLayer = L.geoJSON(cityBoundary, { style:{ color:'orange', weight:2, fillColor:'orange', fillOpacity:0.3 } }).addTo(map);
  map.fitBounds(cityLayer.getBounds());

  // Load buildings
  let allBuildings = [];
  async function loadBuildings(url) {
    const data = await fetch(url).then(r=>r.json());
    allBuildings = allBuildings.concat(data.features);
  }
  await loadBuildings('Huntsville Residential Buildings Part1.geojson');
  await loadBuildings('Huntsville Residential Buildings Part2.geojson');
  await loadBuildings('OSMCombinedUnique_with_GEOIDFQ.geojson');

  const buildingsLayer = L.layerGroup().addTo(map);

  // Helper: convert circle to polygon approximation
  function circleToPolygon(circle, points=64) {
    const latlng = circle.getLatLng();
    const r = circle.getRadius();
    const angleStep = 360 / points;
    const latlngs = [];
    for (let i=0;i<points;i++) {
      const angle = angleStep * i;
      const dest = L.GeometryUtil.destination(latlng, angle, r);
      latlngs.push([dest.lat, dest.lng]);
    }
    return L.polygon(latlngs);
  }

  // Function to check if building polygon intersects drawn shape
  function layerIntersects(layer, buildingCoords) {
    const building = L.polygon(buildingCoords.map(c=>[c[1], c[0]]));
    // First fast bounds check
    if(!layer.getBounds().intersects(building.getBounds())) return false;
    // Then check if any building vertex is inside shape
    const layerPolygon = layer;
    return building.getLatLngs()[0].some(pt => layerPolygon.contains(pt));
  }

  // Show buildings within/intersecting layer
  function showBuildings(drawLayer) {
    buildingsLayer.clearLayers();
    let shapeLayer;
    if (drawLayer instanceof L.Circle) {
      shapeLayer = circleToPolygon(drawLayer);
    } else {
      shapeLayer = drawLayer;
    }

    let count = 0;
    allBuildings.forEach(f => {
      if(!f.geometry || !f.geometry.coordinates) return;
      const coords = f.geometry.coordinates[0]; // assuming Polygon
      if(layerIntersects(shapeLayer, coords)){
        const color = f.properties && f.properties.OSM ? 'darkred' : 'darkgreen';
        L.polygon(coords.map(c=>[c[1], c[0]]), { color, weight:0.3, fillOpacity:0.6, interactive:false }).addTo(buildingsLayer);
        count++;
      }
    });

    // Popup at center
    const center = shapeLayer.getBounds().getCenter();
    L.popup()
     .setLatLng(center)
     .setContent(`<b>${count}</b> building(s) displayed`)
     .openOn(map);
  }

  // Block group click
  blockGroupsLayer.eachLayer(layer => {
    layer.on('click', ()=>showBuildings(layer));
  });

  // Draw control
  const drawControl = new L.Control.Draw({
    draw: { polyline:false, marker:false, circlemarker:false, polygon:true, rectangle:true, circle:true },
    edit:false
  });
  map.addControl(drawControl);

  map.on('draw:created', e=>{
    showBuildings(e.layer);
  });

  // Clear button
  const clearButton = L.control({position:'topright'});
  clearButton.onAdd = function(){
    const div = L.DomUtil.create('div','leaflet-bar leaflet-control');
    div.innerHTML='<a href="#" title="Clear Buildings" style="font-size:16px;line-height:24px;">ðŸ§¹</a>';
    div.style.backgroundColor='white'; div.style.width='34px'; div.style.height='34px';
    div.style.textAlign='center'; div.style.cursor='pointer';
    div.onclick = ()=>buildingsLayer.clearLayers();
    return div;
  };
  clearButton.addTo(map);

})();
</script>

<!-- Leaflet GeometryUtil for circle-to-polygon -->
<script src="https://rawcdn.githack.com/makinacorpus/Leaflet.GeometryUtil/0.9.3/dist/leaflet.geometryutil.min.js"></script>
</body>
</html>
