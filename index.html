<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Huntsville Map - Residential Zones & Address Search</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <style>
        body { margin:0; padding:0; font-family: sans-serif; }
        #map { height: 100vh; }

        #status-panel {
            position: absolute; top: 10px; right: 60px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); border: 2px solid #3388ff;
        }
        .count-num { font-size: 2.2em; color: #2d3436; font-weight: bold; display: block; }
        .label { font-size: 0.8em; color: #636e72; text-transform: uppercase; font-weight: bold; }

        /* Search Panel */
        #search-panel {
            position: absolute;
            top: 50%; right: 20px;
            transform: translateY(-50%);
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            width: 250px;
            z-index: 1000;
        }

        #address-search {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        #suggestions {
            list-style: none;
            padding: 0;
            margin: 5px 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
        }

        #suggestions li {
            padding: 5px;
            cursor: pointer;
        }

        #suggestions li:hover {
            background-color: #eee;
        }

        #go-button {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="status-panel">
        <span class="label">Total Residential Buildings:</span>
        <span id="count-display" class="count-num">0</span>
    </div>

    <div id="search-panel">
        <input type="text" id="address-search" placeholder="Type an address..." />
        <ul id="suggestions"></ul>
        <button id="go-button">Go</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script>
        
    (async function() {
        // Initialize Map
        const map = L.map('map', { renderer: L.canvas(), preferCanvas: true }).setView([34.7304, -86.5861], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const buildingsLayer = L.layerGroup().addTo(map);
        const drawnItems = new L.FeatureGroup().addTo(map);
        let allBuildings = [];

        // Load Background Data
        try {
            const cityData = await fetch('Boundary_City_Huntsville_poly.geojson').then(res => res.json());
            L.geoJSON(cityData, { style: { color: 'orange', weight: 2, fillOpacity: 0.3, interactive: false } }).addTo(map);

            const bgData = await fetch('Huntsville_Block_Groups.geojson').then(res => res.json());
            L.geoJSON(bgData, { style: { color: 'black', weight: 1, fillOpacity: 0, interactive: false } }).addTo(map);

            // Load 4 Residential Buildings files
            const files = [
                'Buildings_Residential_Zones_part1.geojson',
                'Buildings_Residential_Zones_part2.geojson',
                'Buildings_Residential_Zones_part3.geojson',
                'Buildings_Residential_Zones_part4.geojson'
            ];

            for (const f of files) {
                const data = await fetch(f).then(res => res.json());
                allBuildings = allBuildings.concat(data.features);
            }

        } catch (e) { 
            console.error("Error loading GeoJSON files:", e);
        }

        // Function to search buildings inside drawn shapes
        function runBuildingSearch(filterShape) {
            buildingsLayer.clearLayers();

            const searchBbox = turf.bboxPolygon(turf.bbox(filterShape));
            const results = allBuildings.filter(building => {
                const bBox = turf.bboxPolygon(turf.bbox(building));
                if (!turf.booleanIntersects(searchBbox, bBox)) return false;
                return turf.booleanIntersects(building, filterShape);
            });

            document.getElementById('count-display').innerText = results.length.toLocaleString();

            if (results.length > 0) {
                L.geoJSON(results, {
                    style: { color: '#00b894', weight: 1, fillOpacity: 0.6 }, // All green
                    interactive: false
                }).addTo(buildingsLayer);
            }
        }

</script>

        // Drawing Tools
        const drawControl = new L.Control.Draw({
            draw: { 
                polyline: false, 
                marker: false, 
                circlemarker: false, 
                polygon: true, 
                rectangle: true, 
                circle: true 
            },
            edit: false
        });
        map.addControl(drawControl);

        map.on('draw:created', function(e) {
            drawnItems.clearLayers();
            const layer = e.layer;
            drawnItems.addLayer(layer);

            let geoJSON;
            if (layer instanceof L.Circle) {
                const center = layer.getLatLng();
                const radiusKms = layer.getRadius() / 1000;
                geoJSON = turf.circle([center.lng, center.lat], radiusKms, { units: 'kilometers' });
            } else {
                geoJSON = layer.toGeoJSON();
            }

            runBuildingSearch(geoJSON);
        });

        // Manual Reset Button (Broom)
        const cleaner = L.control({position: 'topright'});
        cleaner.onAdd = () => {
            const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            div.innerHTML = '<a href="#" style="background:white;width:34px;height:34px;display:flex;align-items:center;justify-content:center;text-decoration:none;">üßπ</a>';
            div.onclick = (e) => {
                e.preventDefault();
                buildingsLayer.clearLayers();
                drawnItems.clearLayers();
                document.getElementById('count-display').innerText = "0";
            };
            return div;
        };
        cleaner.addTo(map);

        // =====================
        // Zoom Out Button
        // =====================
        const zoomOutControl = L.control({position: 'topright'});
        zoomOutControl.onAdd = () => {
            const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            div.innerHTML = '<a href="#" style="background:white;width:34px;height:34px;display:flex;align-items:center;justify-content:center;text-decoration:none;">üîç‚ûñ</a>';
            div.onclick = (e) => {
                e.preventDefault();
                map.setZoom(map.getZoom() - 1);
            };
            return div;
        };
        zoomOutControl.addTo(map);

        // =====================
        // Address Search Feature
        // =====================
        let allAddresses = [];
        const addressFiles = [
            'Street_Address_Inside_City_LatLon_part1.geojson',
            'Street_Address_Inside_City_LatLon_part2.geojson'
        ];

        for (const f of addressFiles) {
            const data = await fetch(f).then(res => res.json());
            allAddresses = allAddresses.concat(data.features);
        }

        const searchInput = document.getElementById('address-search');
        const suggestionsList = document.getElementById('suggestions');
        const goButton = document.getElementById('go-button');
        let currentMarker = null; // currently displayed search marker
        let selectedCoords = null;

        // Autocomplete
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            suggestionsList.innerHTML = '';
            selectedCoords = null;

            if (!query) return;

            const matches = allAddresses.filter(f => f.properties.Street_Address.toLowerCase().includes(query)).slice(0, 10);

            for (const f of matches) {
                const li = document.createElement('li');
                li.textContent = f.properties.Street_Address;
                li.dataset.lat = f.geometry.coordinates[1];
                li.dataset.lng = f.geometry.coordinates[0];
                li.addEventListener('click', () => {
                    searchInput.value = f.properties.Street_Address;
                    selectedCoords = [f.geometry.coordinates[1], f.geometry.coordinates[0]];
                    suggestionsList.innerHTML = '';
                });
                suggestionsList.appendChild(li);
            }
        });

        // Go Button
        goButton.addEventListener('click', function() {
            if (!selectedCoords) {
                alert('Please select an address from the list.');
                return;
            }

            // Remove previous marker
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            map.setView(selectedCoords, 18);
            
            // Add new marker with tooltip
            const addressName = searchInput.value;
            currentMarker = L.circleMarker(selectedCoords, { radius: 8, color: 'red', fillOpacity: 0.8 })
                .addTo(map)
                .bindTooltip(addressName, { permanent: true, direction: 'top', offset: [0, -10] })
                .openTooltip();
        });

    })();
    </script>
</body>
</html>
