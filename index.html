<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Huntsville Map â€“ Residential Zones & Distance Tool</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

<style>
body { margin:0; padding:0; font-family: sans-serif; }
#map { height: 100vh; }

#status-panel {
    position: absolute;
    top: 10px; right: 60px;
    z-index: 1000;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border: 2px solid #3388ff;
}
.count-num {
    font-size: 2.2em;
    font-weight: bold;
}
.label {
    font-size: 0.8em;
    text-transform: uppercase;
    font-weight: bold;
}

#search-panel {
    position: absolute;
    top: 50%; right: 20px;
    transform: translateY(-50%);
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    width: 250px;
    z-index: 1000;
}

#address-search { width: 100%; padding: 5px; }
#suggestions {
    list-style: none;
    padding: 0;
    margin: 5px 0;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #ccc;
}
#suggestions li { padding: 5px; cursor: pointer; }
#suggestions li:hover { background-color: #eee; }
#go-button { width: 100%; padding: 5px; margin-top: 5px; }

.distance-tooltip {
    background: #2d3436;
    color: white;
    border-radius: 6px;
    padding: 4px 8px;
    font-weight: bold;
}
</style>
</head>

<body>

<div id="status-panel">
    <span class="label">Total Residential Buildings</span>
    <span id="count-display" class="count-num">0</span>
</div>

<div id="search-panel">
    <input type="text" id="address-search" placeholder="Type an address..." />
    <ul id="suggestions"></ul>
    <button id="go-button">Go</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
(async function () {

    // =====================
    // Map Init
    // =====================
    const map = L.map('map', { renderer: L.canvas() })
        .setView([34.7304, -86.5861], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
        .addTo(map);

    const buildingsLayer = L.layerGroup().addTo(map);
    const drawnItems = new L.FeatureGroup().addTo(map);
    let allBuildings = [];

    // =====================
    // Load GeoJSON Data
    // =====================
    try {
        const city = await fetch('Boundary_City_Huntsville_poly.geojson').then(r => r.json());
        L.geoJSON(city, { style:{ color:'orange', weight:2, fillOpacity:0.3 }, interactive:false }).addTo(map);

        const bg = await fetch('Huntsville_Block_Groups.geojson').then(r => r.json());
        L.geoJSON(bg, { style:{ color:'black', weight:1, fillOpacity:0 }, interactive:false }).addTo(map);

        const files = [
            'Buildings_Residential_Zones_part1.geojson',
            'Buildings_Residential_Zones_part2.geojson',
            'Buildings_Residential_Zones_part3.geojson',
            'Buildings_Residential_Zones_part4.geojson'
        ];

        for (const f of files) {
            const d = await fetch(f).then(r => r.json());
            allBuildings = allBuildings.concat(d.features);
        }
    } catch (e) {
        console.error(e);
    }

    // =====================
    // Building Search
    // =====================
    function runBuildingSearch(filterShape) {
        buildingsLayer.clearLayers();

        const searchBbox = turf.bboxPolygon(turf.bbox(filterShape));
        const results = allBuildings.filter(b => {
            const bBox = turf.bboxPolygon(turf.bbox(b));
            if (!turf.booleanIntersects(searchBbox, bBox)) return false;
            return turf.booleanIntersects(b, filterShape);
        });

        document.getElementById('count-display').innerText =
            results.length.toLocaleString();

        L.geoJSON(results, {
            style:{ color:'#00b894', weight:1, fillOpacity:0.6 },
            interactive:false
        }).addTo(buildingsLayer);
    }

    // =====================
    // Draw Controls
    // =====================
    L.drawLocal.draw.handlers.polyline.measurement = ' miles';

    L.GeometryUtil.readableDistance = function (distance) {
        return (distance / 1609.34).toFixed(2) + ' miles';
    };

    const drawControl = new L.Control.Draw({
        draw: {
            polyline: {
                shapeOptions:{ color:'#6c5ce7', weight:4 },
                metric:false,
                feet:false
            },
            polygon:true,
            rectangle:true,
            circle:true,
            marker:false,
            circlemarker:false
        },
        edit: {
            featureGroup: drawnItems,
            edit:true,
            remove:true
        }
    });
    map.addControl(drawControl);

    // =====================
    // Draw Events
    // =====================
    map.on('draw:created', function (e) {
        const layer = e.layer;
        drawnItems.addLayer(layer);

        // Distance line
        if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
            let total = 0;
            const pts = layer.getLatLngs();
            for (let i = 0; i < pts.length - 1; i++) {
                total += pts[i].distanceTo(pts[i + 1]);
            }
            const miles = (total / 1609.34).toFixed(2);
            layer.bindTooltip(`${miles} miles`, {
                permanent:true,
                direction:'center',
                className:'distance-tooltip'
            });
        }

        // Area search
        if (layer instanceof L.Polygon || layer instanceof L.Rectangle || layer instanceof L.Circle) {
            let geo;
            if (layer instanceof L.Circle) {
                const c = layer.getLatLng();
                geo = turf.circle([c.lng, c.lat], layer.getRadius()/1000, { units:'kilometers' });
            } else {
                geo = layer.toGeoJSON();
            }
            runBuildingSearch(geo);
        }
    });

    // =====================
    // Cleaner Button
    // =====================
    const cleaner = L.control({position:'topright'});
    cleaner.onAdd = () => {
        const d = L.DomUtil.create('div','leaflet-bar leaflet-control');
        d.innerHTML = '<a href="#" style="background:white;width:34px;height:34px;display:flex;align-items:center;justify-content:center;">ðŸ§¹</a>';
        d.onclick = e => {
            e.preventDefault();
            drawnItems.clearLayers();
            buildingsLayer.clearLayers();
            document.getElementById('count-display').innerText = '0';
        };
        return d;
    };
    cleaner.addTo(map);

})();
</script>
</body>
</html>
