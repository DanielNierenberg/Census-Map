<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Huntsville ACS 2023 Pro Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --dark-blue: #002f5d; --light-gray: #f4f7f6; --border-color: #ddd; --accent-color: #ff00ff; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: sans-serif; background-color: var(--light-gray); overflow: hidden; }
        
        #banner { height: 5%; width: 100%; background: var(--dark-blue); color: white; display: flex; align-items: center; justify-content: center; box-sizing: border-box; }
        #banner h1 { font-size: 1.2rem; margin: 0; }

        #main-container { display: flex; height: 95%; padding: 10px; box-sizing: border-box; gap: 15px; transition: all 0.3s ease; }
        
        #map-container { flex: 0 0 35%; height: 100%; position: relative; background: white; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; transition: flex 0.3s ease; }
        #map-container.expanded { flex: 0 0 100%; }
        #map { height: 100%; width: 100%; }
        
        #data-container { flex: 1; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding-right: 5px; }
        #data-container.hidden { display: none; }

        #search-panel { position: absolute; top: 10px; left: 50px; z-index: 1000; background: white; padding: 8px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); width: 220px; }
        #address-search { width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        #suggestions { list-style: none; padding: 0; margin: 5px 0 0 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; font-size: 0.8em; background: white; }
        #suggestions li { padding: 6px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
        #suggestions li:hover { background: #f0f0f0; }

        .filter-row { display: flex; gap: 10px; }
        .filter-group { flex: 1; }
        .filter-group label { display: block; font-size: 0.7em; font-weight: bold; margin-bottom: 3px; color: #555; }
        select { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); }
        .kpi-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .kpi-card { background: white; padding: 10px 5px; border-radius: 6px; text-align: center; border: 1px solid var(--border-color); }
        .kpi-card .value { display: block; font-size: 1em; font-weight: bold; color: var(--dark-blue); }
        .kpi-card .label { font-size: 0.6em; color: #777; font-weight: bold; text-transform: uppercase; }
        .viz-row { display: flex; gap: 10px; flex: 1; min-height: 300px; }
        .table-container { flex: 1; background: white; border-radius: 6px; border: 1px solid var(--border-color); overflow-y: auto; }
        .chart-container { flex: 1; background: white; border-radius: 6px; border: 1px solid var(--border-color); padding: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75em; }
        th { background: #f8f9fa; padding: 8px; text-align: left; position: sticky; top: 0; border-bottom: 1px solid #ddd; }
        td { padding: 6px 8px; border-bottom: 1px solid #eee; }
        
        /* Legend Styles */
        .info.legend { background: white; padding: 10px; line-height: 18px; color: #555; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        .info.legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
    </style>
</head>
<body>

<div id="banner"><h1>Huntsville ACS 2023 5-year Block Group Data</h1></div>

<div id="main-container">
    <div id="map-container">
        <div id="search-panel">
            <input type="text" id="address-search" placeholder="Type an address..." autocomplete="off">
            <ul id="suggestions"></ul>
        </div>
        <div id="map"></div>
        <div style="position:absolute; bottom:10px; left:10px; z-index:1000; background:white; padding:5px; border-radius:4px; font-size:0.7em; border:1px solid #ccc;">
            Res. Buildings (Selected): <span id="count-display" style="font-weight:bold">0</span>
        </div>
    </div>

    <div id="data-container">
        <div class="filter-row">
            <div class="filter-group">
                <label>CATEGORY SELECTION</label>
                <select id="category-select">
                    <option value="">-- Select --</option>
                    <option value="Computer/Internet Access">Computer/Internet Access</option>
                    <option value="Employment">Employment</option>
                    <option value="Ethnicity">Ethnicity</option>
                    <option value="House-related">House-related</option>
                    <option value="Language">Language</option>
                    <option value="Population-related">Population-related</option>
                    <option value="Transportation-related">Transportation-related</option>
                </select>
            </div>
            <div class="filter-group">
                <label>CENSUS TABLE SELECTION</label>
                <select id="table-select"><option value="">Select Category First</option></select>
            </div>
            <div class="filter-group">
                <label>MAP LAYER VIEW</label>
                <select id="map-layer-select"><option value="default">Default Map</option></select>
            </div>
        </div>

        <div class="kpi-row">
            <div class="kpi-card"><span class="label">Total Population</span><span id="kpi-pop" class="value">0</span></div>
            <div class="kpi-card"><span class="label">Total Households</span><span id="kpi-hh" class="value">0</span></div>
            <div class="kpi-card"><span class="label">Median Income</span><span id="kpi-income" class="value">$0</span></div>
            <div class="kpi-card"><span class="label">Median House Value</span><span id="kpi-house-val" class="value">$0</span></div>
            <div class="kpi-card"><span class="label">Median Age</span><span id="kpi-age" class="value">0</span></div>
        </div>

        <div class="viz-row">
            <div class="table-container">
                <table id="data-table">
                    <thead><tr><th>Census Parameter</th><th>Count</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="chart-container"><canvas id="barChart"></canvas></div>
        </div>
        <div style="font-size: 0.7em; color: #777;">Data was collected from the 2023 5-year American Community Survey.</div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
const tableMapping = {
    'Computer/Internet Access': { folder: 'Computer and Internet Access', files: {'Computer/Internet Access': 'Computer and Internet Access by Household (DONE).csv'} },
    'Employment': { folder: 'Employment', files: {'Employment Status': 'Employment Status (DONE).csv', 'Household Income': 'Household Income (DONE).csv'} },
    'Ethnicity': { folder: 'Ethnicity', files: {'Race': 'Race (DONE).csv'} },
    'House-related': { folder: 'Housing-related', files: {'Year Housing Built': 'Building Structure Year (DONE).csv', 'Mobile Homes': 'Mobile Homes (DONE).csv', 'Housing Unit Value': 'Owner-Occupied Housing Unit Value (DONE).csv'} },
    'Language': { folder: 'Language', files: {'Limited English': 'Limited English Households (DONE).csv'} },
    'Population-related': { folder: 'Population-related', files: {'Age and Gender': 'Age and Gender (DONE).csv', 'Family Size': 'Family Size (DONE).csv', 'Marriage, Children, and Living alone': 'Marriage, Children, and Living alone status (DONE).csv', 'Health Insurance Status': 'Population - No Health Insurance (DONE).csv', 'Education': 'Population by Education (DONE).csv', 'Poverty Status': 'Population by Poverty Status (DONE).csv', 'SNAP and Disability Status': 'SNAP and Disability (DONE).csv', 'Veterans': 'Veteran Status (DONE).csv'} },
    'Transportation-related': { folder: 'Transportation-related', files: {'Means of Transportation': 'Means of Transportation to work (DONE).csv', 'Travel time to work': 'Travel Time to Work (DONE).csv', 'Vehicle availability': 'Vehicle Availability - Households (DONE).csv'} }
};

(async function() {
    const map = L.map('map', { renderer: L.canvas() }).setView([34.7304, -86.5861], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const buildingsLayer = L.layerGroup().addTo(map);
    const drawnItems = new L.FeatureGroup().addTo(map);
    const legend = L.control({position: 'bottomright'});
    
    let bgLayer, currentCSVData = [], allBuildings = [], allAddresses = [], buildingCounts = {};
    let activeBlockGroup = null, chartInstance = null, currentMarker = null, currentShape = null;

    const initialStyle = { color: 'black', weight: 1, fillOpacity: 0, fill: false };

    // --- NEW: Load City Boundary ---
    try {
        const cityData = await fetch('Boundary_City_Huntsville_poly.geojson').then(res => res.json());
        L.geoJSON(cityData, { style: { color: 'orange', weight: 2, fillOpacity: 0.05, interactive: false } }).addTo(map);
    } catch(e) { console.log("City boundary file not found."); }

    async function loadCSV(path) {
        const r = await fetch(path);
        const t = await r.text();
        return Papa.parse(t, { header: true, dynamicTyping: true, skipEmptyLines: true }).data;
    }

    // Load building counts for High-Accuracy Weighting
    const countsData = await loadCSV('1-9-26 Hun residential building counts per block group.csv');
    countsData.forEach(row => { buildingCounts[row.GEOIDFQ] = row.building_count; });

    const bgData = await fetch('Huntsville_Block_Groups.geojson').then(r => r.json());

    function getSelectedIDs() {
        if (currentShape) {
            return bgData.features.filter(f => turf.booleanIntersects(f, currentShape)).map(f => f.properties.GEOIDFQ);
        } else if (activeBlockGroup) {
            return [activeBlockGroup];
        }
        return []; 
    }

    function getBGWeight(geoid) {
        if (activeBlockGroup === geoid) return 1.0; 
        if (!currentShape) return 1.0; 
        const totalInBG = buildingCounts[geoid] || 0;
        if (totalInBG === 0) return 0;
        const selectedInBG = allBuildings.filter(b => b.properties.GEOIDFQ === geoid && turf.booleanIntersects(b, currentShape)).length;
        return selectedInBG / totalInBG;
    }

    // --- IMPROVED: Map Layer with Tooltips & Dynamic Legend ---
    function updateMapLayer() {
        const selectedCol = document.getElementById('map-layer-select').value;
        const max = (selectedCol !== 'default' && currentCSVData.length) ? Math.max(...currentCSVData.map(r => r[selectedCol] || 0)) : 0;
        const highlightedIDs = getSelectedIDs();

        bgLayer.eachLayer(layer => {
            const props = layer.feature.properties;
            const geoid = props.GEOIDFQ;
            const row = currentCSVData.find(r => r.GEO_ID === geoid);
            
            // Tooltip Logic
            let tip = `<strong>Block Group:</strong> ${geoid}`;
            if (selectedCol !== 'default' && row) {
                tip += `<br>${selectedCol}: ${row[selectedCol]?.toLocaleString() || 0}`;
            }
            layer.bindTooltip(tip);

            let style = { ...initialStyle };
            if (selectedCol !== 'default') {
                const val = row?.[selectedCol] || 0;
                style.fill = true;
                style.fillColor = '#4a148c'; 
                style.fillOpacity = val > 0 ? (val / max) * 0.8 : 0;
            }
            if (highlightedIDs.includes(geoid)) {
                style.color = '#FFFF00'; style.weight = 4; style.opacity = 1;
            }
            layer.setStyle(style);
        });

        // Dynamic Legend
        legend.remove(map);
        if (selectedCol !== 'default') {
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = [0, max*0.25, max*0.5, max*0.75];
                div.innerHTML = `<strong>${selectedCol}</strong><br>`;
                for (let i = 0; i < grades.length; i++) {
                    div.innerHTML += `<i style="background:#4a148c; opacity:${(grades[i]/max) || 0.1}"></i> ${Math.round(grades[i]).toLocaleString()}+<br>`;
                }
                return div;
            };
            legend.addTo(map);
        }
    }

    bgLayer = L.geoJSON(bgData, {
        style: initialStyle,
        onEachFeature: (feature, layer) => {
            layer.on('click', () => {
                drawnItems.clearLayers(); currentShape = null;
                activeBlockGroup = (activeBlockGroup === feature.properties.GEOIDFQ) ? null : feature.properties.GEOIDFQ;
                updateMapLayer(); updateKPIs(); updateViz();
            });
        }
    }).addTo(map);

    let kpiRaw = {};
    async function initKPIs() {
        kpiRaw.pop = await loadCSV('Totals/Total Population.csv');
        kpiRaw.hh = await loadCSV('Totals/Total Households.csv');
        kpiRaw.inc = await loadCSV('Employment/Median Household Income (DONE).csv');
        kpiRaw.hou = await loadCSV('Housing-related/Median Owner-Occupied Housing Unit Value (DONE).csv');
        kpiRaw.age = await loadCSV('Population-related/Median Age (DONE).csv');
        updateKPIs();
    }

    function updateKPIs() {
        const ids = getSelectedIDs();
        let totalPop = 0, totalHH = 0, weightedIncSum = 0, incDenom = 0, weightedValSum = 0, valDenom = 0, weightedAgeSum = 0, ageDenom = 0;

        ids.forEach(geoid => {
            const weight = getBGWeight(geoid);
            const popRow = kpiRaw.pop.find(r => r.GEO_ID === geoid);
            const hhRow = kpiRaw.hh.find(r => r.GEO_ID === geoid);
            const bgPop = (popRow?.Total || 0) * weight;
            totalPop += bgPop;
            totalHH += (hhRow?.Total || 0) * weight;

            const incRow = kpiRaw.inc.find(r => r.GEO_ID === geoid);
            if (incRow?.['Median household income (past 12 months)'] > 0) {
                weightedIncSum += incRow['Median household income (past 12 months)'] * bgPop;
                incDenom += bgPop;
            }
            const houRow = kpiRaw.hou.find(r => r.GEO_ID === geoid);
            if (houRow?.['Median value ($)'] > 0) {
                weightedValSum += houRow['Median value ($)'] * bgPop;
                valDenom += bgPop;
            }
            const ageRow = kpiRaw.age.find(r => r.GEO_ID === geoid);
            if (ageRow?.['Median Age'] > 0) {
                weightedAgeSum += ageRow['Median Age'] * bgPop;
                ageDenom += bgPop;
            }
        });

        document.getElementById('kpi-pop').innerText = Math.round(totalPop).toLocaleString();
        document.getElementById('kpi-hh').innerText = Math.round(totalHH).toLocaleString();
        document.getElementById('kpi-income').innerText = incDenom ? '$' + Math.round(weightedIncSum / incDenom).toLocaleString() : 'N/A';
        document.getElementById('kpi-house-val').innerText = valDenom ? '$' + Math.round(weightedValSum / valDenom).toLocaleString() : 'N/A';
        document.getElementById('kpi-age').innerText = ageDenom ? (weightedAgeSum / ageDenom).toFixed(1) : 'N/A';
    }

    function updateViz() {
        if (!currentCSVData.length) return;
        const ids = getSelectedIDs();
        const cols = Object.keys(currentCSVData[0]).filter(c => c !== 'GEO_ID' && c !== 'NAME' && !c.endsWith('_MOE'));
        
        const sums = cols.map(c => {
            let total = 0;
            ids.forEach(geoid => {
                const row = currentCSVData.find(r => r.GEO_ID === geoid);
                if (row) total += (Number(row[c]) || 0) * getBGWeight(geoid);
            });
            return { param: c, val: Math.round(total) };
        }).sort((a, b) => b.val - a.val);

        document.querySelector('#data-table tbody').innerHTML = sums.map(s => `<tr><td>${s.param}</td><td>${s.val.toLocaleString()}</td></tr>`).join('');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('barChart'), {
            type: 'bar', data: { labels: sums.map(s => s.param), datasets: [{ label: 'Apportioned Count', data: sums.map(s => s.val), backgroundColor: '#002f5d' }] },
            options: { indexAxis: 'y', maintainAspectRatio: false }
        });
    }

    // --- DRAWING & BUTTONS ---
    const drawControl = new L.Control.Draw({ draw: { polyline: false, marker: false, circlemarker: false, polygon: true, rectangle: true, circle: true }, edit: false });
    map.addControl(drawControl);

    map.on('draw:created', e => {
        drawnItems.clearLayers(); drawnItems.addLayer(e.layer);
        activeBlockGroup = null;
        currentShape = (e.layer instanceof L.Circle) ? turf.circle([e.layer.getLatLng().lng, e.layer.getLatLng().lat], e.layer.getRadius() / 1000, { units: 'kilometers' }) : e.layer.toGeoJSON();
        
        const bResults = allBuildings.filter(b => turf.booleanIntersects(b, currentShape));
        document.getElementById('count-display').innerText = bResults.length.toLocaleString();
        buildingsLayer.clearLayers();
        L.geoJSON(bResults, { style: { color: '#ff00ff', weight: 1, fillOpacity: 0.7 } }).addTo(buildingsLayer);
        
        updateMapLayer(); updateKPIs(); updateViz();
    });

    // Reset Button
    const clearBtn = L.control({position: 'topright'});
    clearBtn.onAdd = () => {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = '<a href="#" title="Clear" style="background:white;width:30px;height:30px;display:flex;align-items:center;justify-content:center;text-decoration:none;">‚ùå</a>';
        div.onclick = (e) => { 
            e.preventDefault(); 
            buildingsLayer.clearLayers(); drawnItems.clearLayers();
            if (currentMarker) map.removeLayer(currentMarker);
            currentShape = null; activeBlockGroup = null; 
            document.getElementById('count-display').innerText = "0";
            updateMapLayer(); updateKPIs(); updateViz();
        };
        return div;
    };
    clearBtn.addTo(map);

    // Home Button
    const homeBtn = L.control({position: 'topright'});
    homeBtn.onAdd = () => {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = '<a href="#" title="Home" style="background:white;width:30px;height:30px;display:flex;align-items:center;justify-content:center;text-decoration:none;">üè†</a>';
        div.onclick = (e) => { e.preventDefault(); map.setView([34.7304, -86.5861], 12); };
        return div;
    };
    homeBtn.addTo(map);

    // Expand Map Button
    const expandBtn = L.control({position: 'topright'});
    expandBtn.onAdd = () => {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = '<a href="#" title="Expand Map" style="background:white;width:30px;height:30px;display:flex;align-items:center;justify-content:center;text-decoration:none;font-weight:bold;">‚§¢</a>';
        div.onclick = (e) => { 
            e.preventDefault(); 
            document.getElementById('map-container').classList.toggle('expanded');
            document.getElementById('data-container').classList.toggle('hidden');
            setTimeout(() => map.invalidateSize(), 350); 
        };
        return div;
    };
    expandBtn.addTo(map);

    // --- SEARCH & RADIUS LOGIC ---
    const searchInput = document.getElementById('address-search');
    const suggestionsList = document.getElementById('suggestions');

    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        suggestionsList.innerHTML = '';
        if (query.length < 2) return;
        const matches = allAddresses.filter(f => f.properties.Street_Address.toLowerCase().includes(query)).slice(0, 10);
        matches.forEach(f => {
            const li = document.createElement('li');
            li.textContent = f.properties.Street_Address;
            li.onclick = () => {
                const addressText = f.properties.Street_Address;
                searchInput.value = addressText;
                const coords = [f.geometry.coordinates[1], f.geometry.coordinates[0]];
                suggestionsList.innerHTML = '';
                map.setView(coords, 16);
                if (currentMarker) map.removeLayer(currentMarker);
                currentMarker = L.circleMarker(coords, { radius: 8, color: 'red', fillOpacity: 0.8 }).addTo(map);

                const container = document.createElement('div');
                container.innerHTML = `
                    <div style="margin-bottom:8px;"><strong>${addressText}</strong></div>
                    Radius (miles): <input type="number" id="rad-val" step="0.1" value="1.0" style="width:50px;">
                    <button id="rad-submit" style="background:var(--dark-blue); color:white; border:none; padding:5px; border-radius:3px; cursor:pointer;">Go</button>`;
                
                currentMarker.bindPopup(container).openPopup();

                container.querySelector('#rad-submit').onclick = () => {
                    const miles = container.querySelector('#rad-val').value;
                    const radiusKm = parseFloat(miles) * 1.60934;
                    const circleGeoJSON = turf.circle([f.geometry.coordinates[0], f.geometry.coordinates[1]], radiusKm, { units: 'kilometers' });
                    
                    drawnItems.clearLayers();
                    currentShape = circleGeoJSON;
                    L.geoJSON(circleGeoJSON, { style: { color: '#3388ff', weight: 2, fillOpacity: 0.2 } }).addTo(drawnItems);
                    
                    const bResults = allBuildings.filter(b => turf.booleanIntersects(b, currentShape));
                    document.getElementById('count-display').innerText = bResults.length.toLocaleString();
                    buildingsLayer.clearLayers();
                    L.geoJSON(bResults, { style: { color: '#ff00ff', weight: 1, fillOpacity: 0.7 } }).addTo(buildingsLayer);

                    updateMapLayer(); updateKPIs(); updateViz();
                    map.closePopup();
                };
            };
            suggestionsList.appendChild(li);
        });
    });

    // --- CATEGORY HANDLERS ---
    document.getElementById('category-select').addEventListener('change', (e) => {
        const ts = document.getElementById('table-select');
        ts.innerHTML = '<option value="">-- Select --</option>';
        if (tableMapping[e.target.value]) Object.keys(tableMapping[e.target.value].files).forEach(f => ts.innerHTML += `<option value="${f}">${f}</option>`);
    });

    document.getElementById('table-select').addEventListener('change', async (e) => {
        const cat = document.getElementById('category-select').value;
        if (!e.target.value) return;
        currentCSVData = await loadCSV(`${tableMapping[cat].folder}/${tableMapping[cat].files[e.target.value]}`);
        const mls = document.getElementById('map-layer-select');
        mls.innerHTML = '<option value="default">Default Map</option>';
        Object.keys(currentCSVData[0]).forEach(c => { if(c!=='GEO_ID' && c!=='NAME' && !c.endsWith('_MOE')) mls.innerHTML += `<option value="${c}">${c}</option>`; });
        updateViz(); updateMapLayer();
    });

    document.getElementById('map-layer-select').addEventListener('change', updateMapLayer);
    
    // Load Files
    const bFiles = ['1-9-26 Hun residential buildings with geoid p1.geojson', '1-9-26 Hun residential buildings with geoid p2.geojson', '1-9-26 Hun residential buildings with geoid p3.geojson', '1-9-26 Hun residential buildings with geoid p4.geojson'];
    for (const f of bFiles) { fetch(f).then(r => r.json()).then(d => allBuildings = allBuildings.concat(d.features)); }

    const aFiles = ['Street_Address_Inside_City_LatLon_part1.geojson', 'Street_Address_Inside_City_LatLon_part2.geojson'];
    for (const f of aFiles) { fetch(f).then(r => r.json()).then(d => allAddresses = allAddresses.concat(d.features)); }
    
    initKPIs();
})();
</script>
</body>
</html>
