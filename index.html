<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Huntsville Map - Residential Zones & Choropleth</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <style>
        body { margin:0; padding:0; font-family: sans-serif; }
        #map { height: 100vh; }

        /* Controls Panel */
        #control-panel {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        #status-panel {
            position: absolute; top: 10px; right: 60px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); border: 2px solid #3388ff;
        }
        .count-num { font-size: 2.2em; color: #2d3436; font-weight: bold; display: block; }
        .label { font-size: 0.8em; color: #636e72; text-transform: uppercase; font-weight: bold; }

        #search-panel {
            position: absolute; top: 110px; right: 20px;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2); width: 250px; z-index: 1000;
        }

        #address-search { width: 100%; padding: 5px; box-sizing: border-box; }
        #suggestions { list-style: none; padding: 0; margin: 5px 0; max-height: 150px; overflow-y: auto; border: 1px solid #ccc; }
        #suggestions li { padding: 5px; cursor: pointer; }
        #suggestions li:hover { background-color: #eee; }
        #go-button { width: 100%; padding: 5px; margin-top: 5px; cursor: pointer; }

        .popup-container { text-align: center; padding: 5px; }
        .popup-btn { display: block; width: 100%; margin: 5px 0; padding: 8px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; }
        .btn-radius { background: #3388ff; color: white; border: none; font-weight: bold; }
        
        select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; width: 200px; }

        /* Legend Styling */
        .info.legend {
            padding: 10px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            line-height: 18px;
            color: #555;
        }
        .info.legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div id="control-panel">
        <label class="label" style="display:block; margin-bottom:5px;">Map Layer View:</label>
        <select id="csv-dropdown">
            <option value="default">Default Map</option>
            <option value="Total Population">Total Population</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>
    </div>

    <div id="status-panel">
        <span class="label">Total Residential Buildings:</span>
        <span id="count-display" class="count-num">0</span>
    </div>

    <div id="search-panel">
        <input type="text" id="address-search" placeholder="Type an address..." autocomplete="off" />
        <ul id="suggestions"></ul>
        <button id="go-button">Go</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
    (async function() {
        // 1. Initialize Map
        const map = L.map('map', { renderer: L.canvas(), preferCanvas: true }).setView([34.7304, -86.5861], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const buildingsLayer = L.layerGroup().addTo(map);
        const drawnItems = new L.FeatureGroup().addTo(map);
        let blockGroupLayer = null;
        let csvDataMap = {}; 
        let allBuildings = [];
        let allAddresses = [];
        let currentMarker = null;
        let selectedCoords = null;

        // Helper: Get color based on value (Shades of Purple)
        function getColor(v, max) {
            if (max === 0 || !v) return '#f2f0f7';
            const pct = v / max;
            return pct > 0.8 ? '#3f007d' :
                   pct > 0.6 ? '#6a51a3' :
                   pct > 0.4 ? '#807dba' :
                   pct > 0.2 ? '#bcbddc' :
                               '#f2f0f7';
        }

        try {
            // 2. Load CSV Data
            const csvResponse = await fetch('Sex by Age - Truncated Cleaned.csv');
            const csvText = await csvResponse.text();
            const parsedCsv = Papa.parse(csvText, { header: true, dynamicTyping: true });
            
            parsedCsv.data.forEach(row => {
                if (row.Geography) csvDataMap[row.Geography] = row;
            });

            // 3. Load Geometries
            const cityData = await fetch('Boundary_City_Huntsville_poly.geojson').then(res => res.json());
            L.geoJSON(cityData, { style: { color: 'orange', weight: 2, fillOpacity: 0.3, interactive: false } }).addTo(map);

            const bgData = await fetch('Huntsville_Block_Groups.geojson').then(res => res.json());
            
        blockGroupLayer = L.geoJSON(bgData, {
    style: { color: 'black', weight: 1, fillOpacity: 0 },
    onEachFeature: (feature, layer) => {
        layer.on('mouseover', function(e) {
            const selectedCol = document.getElementById('csv-dropdown').value;
            
            // MODIFY THIS BLOCK:
            if (selectedCol !== 'default') {
                const geoid = feature.properties.GEOIDFQ;
                const val = csvDataMap[geoid] ? csvDataMap[geoid][selectedCol] : 0;
                layer.bindTooltip(`<strong>${selectedCol}:</strong> ${val.toLocaleString()}`).openTooltip();
                this.setStyle({ weight: 3, color: '#333' });
            } else {
                // Ensure no tooltip is bound or shown in default mode
                layer.unbindTooltip(); 
            }
        });

        layer.on('mouseout', function(e) {
            const selectedCol = document.getElementById('csv-dropdown').value;
            if (selectedCol === 'default') {
                blockGroupLayer.resetStyle(this);
            } else {
                const values = Object.values(csvDataMap).map(r => r[selectedCol] || 0);
                const maxVal = Math.max(...values);
                const geoid = feature.properties.GEOIDFQ;
                const val = csvDataMap[geoid] ? csvDataMap[geoid][selectedCol] : 0;
                
                this.setStyle({
                    fillColor: getColor(val, maxVal),
                    fillOpacity: 0.7,
                    color: 'black',
                    weight: 1
                });
            }
            layer.closeTooltip();
        });
    }
}).addTo(map);

            // 4. Load Buildings and Addresses
            const buildingFiles = ['Buildings_Residential_Zones_part1.geojson', 'Buildings_Residential_Zones_part2.geojson', 'Buildings_Residential_Zones_part3.geojson', 'Buildings_Residential_Zones_part4.geojson'];
            for (const f of buildingFiles) {
                const data = await fetch(f).then(res => res.json());
                allBuildings = allBuildings.concat(data.features);
            }

            const addressFiles = ['Street_Address_Inside_City_LatLon_part1.geojson', 'Street_Address_Inside_City_LatLon_part2.geojson'];
            for (const f of addressFiles) {
                const data = await fetch(f).then(res => res.json());
                allAddresses = allAddresses.concat(data.features);
            }

        } catch (e) { console.error("Error loading data:", e); }

        // 5. Legend Logic Function
        const legend = L.control({position: 'bottomright'});
        function updateLegend(selectedCol) {
            if (map.legend) { map.removeControl(map.legend); map.legend = null; }
            if (selectedCol === 'default') return;

            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const values = Object.values(csvDataMap).map(r => r[selectedCol] || 0);
                const maxVal = Math.max(...values);
                const grades = [0, Math.round(maxVal * 0.2), Math.round(maxVal * 0.4), Math.round(maxVal * 0.6), Math.round(maxVal * 0.8)];
                
                div.innerHTML = `<strong>${selectedCol}</strong><br>`;
                for (let i = 0; i < grades.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + getColor(grades[i] + 1, maxVal) + '"></i> ' +
                        grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
                }
                return div;
            };
            legend.addTo(map);
            map.legend = legend;
        }

        // 6. Combined Dropdown Change Logic
        document.getElementById('csv-dropdown').addEventListener('change', function(e) {
            const selectedCol = e.target.value;
            
            if (selectedCol === 'default') {
                blockGroupLayer.setStyle({ fillOpacity: 0, color: 'black', weight: 1 });
            } else {
                const values = Object.values(csvDataMap).map(r => r[selectedCol] || 0);
                const maxVal = Math.max(...values);

                blockGroupLayer.setStyle(feature => {
                    const geoid = feature.properties.GEOIDFQ;
                    const val = csvDataMap[geoid] ? csvDataMap[geoid][selectedCol] : 0;
                    return {
                        fillColor: getColor(val, maxVal),
                        fillOpacity: 0.7,
                        color: 'black',
                        weight: 1
                    };
                });
            }
            updateLegend(selectedCol);
        });

        // 7. Search & Drawing Tools
        function runBuildingSearch(filterShape) {
            buildingsLayer.clearLayers();
            const searchBbox = turf.bboxPolygon(turf.bbox(filterShape));
            const results = allBuildings.filter(building => {
                const bBox = turf.bboxPolygon(turf.bbox(building));
                if (!turf.booleanIntersects(searchBbox, bBox)) return false;
                return turf.booleanIntersects(building, filterShape);
            });
            document.getElementById('count-display').innerText = results.length.toLocaleString();
            if (results.length > 0) {
                L.geoJSON(results, { style: { color: '#00b894', weight: 1, fillOpacity: 0.6 }, interactive: false }).addTo(buildingsLayer);
            }
        }

        const drawControl = new L.Control.Draw({
            draw: { polyline: false, marker: false, circlemarker: false, polygon: true, rectangle: true, circle: true },
            edit: false
        });
        map.addControl(drawControl);

        map.on('draw:created', function(e) {
            drawnItems.clearLayers();
            const layer = e.layer;
            drawnItems.addLayer(layer);
            let geoJSON = (layer instanceof L.Circle) ? 
                turf.circle([layer.getLatLng().lng, layer.getLatLng().lat], layer.getRadius() / 1000, { units: 'kilometers' }) : 
                layer.toGeoJSON();
            runBuildingSearch(geoJSON);
        });

        const searchInput = document.getElementById('address-search');
        const suggestionsList = document.getElementById('suggestions');
        const goButton = document.getElementById('go-button');

        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            suggestionsList.innerHTML = '';
            selectedCoords = null;
            if (!query) return;
            const matches = allAddresses.filter(f => f.properties.Street_Address.toLowerCase().includes(query)).slice(0, 10);
            matches.forEach(f => {
                const li = document.createElement('li');
                li.textContent = f.properties.Street_Address;
                li.onclick = () => {
                    searchInput.value = f.properties.Street_Address;
                    selectedCoords = [f.geometry.coordinates[1], f.geometry.coordinates[0]];
                    suggestionsList.innerHTML = '';
                };
                suggestionsList.appendChild(li);
            });
        });

        goButton.addEventListener('click', function() {
            if (!selectedCoords) return alert('Please select an address from the list.');
            if (currentMarker) map.removeLayer(currentMarker);
            map.setView(selectedCoords, 17);
            currentMarker = L.circleMarker(selectedCoords, { radius: 10, color: 'red', fillColor: '#f03', fillOpacity: 0.8 }).addTo(map);
            const container = document.createElement('div');
            container.className = 'popup-container';
            container.innerHTML = `<strong>${searchInput.value}</strong><br><button class="popup-btn btn-radius" id="pop-radius">Enter Mile Radius</button><button class="popup-btn" id="pop-cancel">Cancel</button>`;
            currentMarker.bindPopup(container).openPopup();
            container.querySelector('#pop-cancel').onclick = () => map.closePopup();
            container.querySelector('#pop-radius').onclick = () => {
                const miles = prompt("Enter radius in miles:");
                if (miles && !isNaN(miles)) {
                    const circleGeoJSON = turf.circle([selectedCoords[1], selectedCoords[0]], parseFloat(miles) * 1.60934, { units: 'kilometers' });
                    drawnItems.clearLayers();
                    L.geoJSON(circleGeoJSON, { style: { color: '#3388ff', weight: 2, fillOpacity: 0.2 } }).addTo(drawnItems);
                    runBuildingSearch(circleGeoJSON);
                    map.closePopup();
                }
            };
        });

        const cleaner = L.control({position: 'topright'});
        cleaner.onAdd = () => {
            const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            div.innerHTML = '<a href="#" title="Clear All" style="background:white;width:34px;height:34px;display:flex;align-items:center;justify-content:center;text-decoration:none;">‚ùå</a>';
            div.onclick = (e) => {
                e.preventDefault();
                buildingsLayer.clearLayers();
                drawnItems.clearLayers();
                if (currentMarker) map.removeLayer(currentMarker);
                document.getElementById('count-display').innerText = "0";
                searchInput.value = '';
            };
            return div;
        };
        cleaner.addTo(map);

        const zoomOutControl = L.control({position: 'topright'});
        zoomOutControl.onAdd = () => {
            const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            div.innerHTML = '<a href="#" title="Reset Zoom" style="background:white;width:34px;height:34px;display:flex;align-items:center;justify-content:center;text-decoration:none;">üè†</a>';
            div.onclick = (e) => { e.preventDefault(); map.setView([34.7304, -86.5861], 12); };
            return div;
        };
        zoomOutControl.addTo(map);

    })();
    </script>
</body>
</html>
