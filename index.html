<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Huntsville ACS 2023 Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <style>
        :root { --blue: #002f5d; --bg: #f4f7f6; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #banner { background: var(--blue); color: white; padding: 10px; text-align: center; }
        #main { display: flex; flex: 1; padding: 10px; gap: 10px; height: calc(100% - 40px); }
        #map-container { flex: 0 0 40%; position: relative; background: white; border-radius: 8px; border: 1px solid #ddd; transition: 0.3s; }
        #map-container.expanded { flex: 1; }
        #map { height: 100%; border-radius: 8px; }
        #data-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        #data-panel.hidden { display: none; }
        #search-panel { position: absolute; top: 10px; left: 50px; z-index: 1000; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); width: 250px; }
        input, select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        #suggestions { list-style: none; padding: 0; margin: 5px 0 0; max-height: 150px; overflow-y: auto; background: white; font-size: 0.8em; }
        #suggestions li { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        .kpi-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .kpi-card { background: white; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #ddd; }
        .kpi-card span { display: block; }
        .val { font-weight: bold; color: var(--blue); font-size: 1.1em; }
        .lab { font-size: 0.6em; color: #666; text-transform: uppercase; }
        .viz-row { display: flex; gap: 10px; flex: 1; min-height: 350px; }
        .table-wrap { flex: 1; background: white; border-radius: 8px; border: 1px solid #ddd; overflow-y: auto; font-size: 0.8em; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; position: sticky; top: 0; }
        .chart-wrap { flex: 1; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loader"><div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div><p id="status">Loading Huntsville Data...</p></div>
<div id="banner"><strong>Huntsville ACS 2023 Demographic Engine</strong></div>
<div id="main">
    <div id="map-container">
        <div id="search-panel"><input type="text" id="address-search" placeholder="Search Address..."><ul id="suggestions"></ul></div>
        <div id="map"></div>
        <div style="position:absolute; bottom:10px; left:10px; z-index:1000; background:white; padding:5px; border-radius:4px; font-size:0.7em;">Units: <b id="count-display">0</b></div>
    </div>
    <div id="data-panel">
        <div style="display:flex; gap:10px; background:white; padding:10px; border-radius:8px; border:1px solid #ddd;">
            <select id="cat-sel"><option value="">-- Category --</option></select>
            <select id="tab-sel"><option value="">-- Table --</option></select>
        </div>
        <div class="kpi-row">
            <div class="kpi-card"><span class="lab">Population</span><span id="k-pop" class="val">0</span></div>
            <div class="kpi-card"><span class="lab">Households</span><span id="k-hh" class="val">0</span></div>
            <div class="kpi-card"><span class="lab">Avg Income</span><span id="k-inc" class="val">$0</span></div>
            <div class="kpi-card"><span class="lab">House Value</span><span id="k-val" class="val">$0</span></div>
            <div class="kpi-card"><span class="lab">Median Age</span><span id="k-age" class="val">0</span></div>
        </div>
        <div class="viz-row">
            <div class="table-wrap"><table><thead><tr><th>Variable</th><th>Est. Count</th></tr></thead><tbody id="data-body"></tbody></table></div>
            <div class="chart-wrap"><canvas id="barChart"></canvas></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
const map = L.map('map', {zoomControl: false}).setView([34.7304, -86.5861], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const drawnItems = new L.FeatureGroup().addTo(map);

let allB = [], allA = [], csvData = [], bMap = [], bPerBG = {}, kpi = {}, chart = null, shape = null, marker = null;

const mapping = {
    'Employment': { f: 'Employment', t: {'Income': 'Household Income (DONE).csv', 'Status': 'Employment Status (DONE).csv'} },
    'Housing': { f: 'Housing-related', t: {'Value': 'Owner-Occupied Housing Unit Value (DONE).csv', 'Built': 'Building Structure Year (DONE).csv'} },
    'Population': { f: 'Population-related', t: {'Age': 'Age and Gender (DONE).csv', 'Education': 'Population by Education (DONE).csv', 'Poverty': 'Population by Poverty Status (DONE).csv'} }
};

async function load(url) { const r = await fetch(url); return url.endsWith('.csv') ? Papa.parse(await r.text(), {header:true, dynamicTyping:true}).data : r.json(); }

async function init() {
    Object.keys(mapping).forEach(k => document.getElementById('cat-sel').innerHTML += `<option value="${k}">${k}</option>`);
    const bFiles = [1,2,3,4].map(i => `Buildings_Residential_Zones_part${i}.geojson`);
    for (const f of bFiles) { const d = await load(f); allB = allB.concat(d.features); }
    const aFiles = [1,2].map(i => `Street_Address_Inside_City_LatLon_part${i}.geojson`);
    for (const f of aFiles) { const d = await load(f); allA = allA.concat(d.features); }

    allB.forEach(b => { 
        const g = b.properties.GEOIDFQ; bPerBG[g] = (bPerBG[g] || 0) + 1; 
        bMap.push({p: b.geometry.coordinates, g});
    });

    kpi.pop = await load('Totals/Total Population.csv');
    kpi.hh = await load('Totals/Total Households.csv');
    kpi.inc = await load('Employment/Median Household Income (DONE).csv');
    kpi.val = await load('Housing-related/Median Owner-Occupied Housing Unit Value (DONE).csv');
    kpi.age = await load('Population-related/Median Age (DONE).csv');
    
    document.getElementById('loader').style.display = 'none';
    update();
}

function update() {
    let sel = {}, total = 0, bbox = shape ? turf.bbox(shape) : null;
    bMap.forEach(b => {
        if (!shape || (b.p[0] >= bbox[0] && b.p[0] <= bbox[2] && b.p[1] >= bbox[1] && b.p[1] <= bbox[3] && turf.booleanPointInPolygon(b.p, shape))) {
            sel[b.g] = (sel[b.g] || 0) + 1; total++;
        }
    });
    document.getElementById('count-display').innerText = total.toLocaleString();

    let tPop = 0, tHH = 0, wIncSum = 0, wIncW = 0, wValSum = 0, wValW = 0, wAgeSum = 0, wAgeW = 0;
    Object.keys(sel).forEach(g => {
        const r = sel[g] / (bPerBG[g] || 1);
        const p = (kpi.pop.find(x => x.GEO_ID === g)?.['Total'] || 0) * r;
        const h = (kpi.hh.find(x => x.GEO_ID === g)?.['Total'] || 0) * r;
        tPop += p; tHH += h;
        const inc = kpi.inc.find(x => x.GEO_ID === g)?.['Median household income (past 12 months)'] || 0;
        const v = kpi.val.find(x => x.GEO_ID === g)?.['Median value ($)'] || 0;
        const a = kpi.age.find(x => x.GEO_ID === g)?.['Median Age'] || 0;
        if (inc > 0) { wIncSum += inc * p; wIncW += p; }
        if (v > 0) { wValSum += v * p; wValW += p; }
        if (a > 0) { wAgeSum += a * p; wAgeW += p; }
    });

    document.getElementById('k-pop').innerText = Math.round(tPop).toLocaleString();
    document.getElementById('k-hh').innerText = Math.round(tHH).toLocaleString();
    document.getElementById('k-inc').innerText = wIncW > 0 ? `$${Math.round(wIncSum/wIncW).toLocaleString()}` : 'N/A';
    document.getElementById('k-val').innerText = wValW > 0 ? `$${Math.round(wValSum/wValW).toLocaleString()}` : 'N/A';
    document.getElementById('k-age').innerText = wAgeW > 0 ? (wAgeSum/wAgeW).toFixed(1) : 'N/A';

    if (csvData.length) {
        const cols = Object.keys(csvData[0]).filter(c => !['GEO_ID','NAME'].includes(c) && !c.endsWith('_MOE'));
        const res = cols.map(c => {
            let s = 0; Object.keys(sel).forEach(g => { s += (Number(csvData.find(x => x.GEO_ID === g)?.[c]) || 0) * (sel[g] / bPerBG[g]); });
            return {l: c, v: Math.round(s)};
        }).sort((a,b) => b.v - a.v);
        document.getElementById('data-body').innerHTML = res.map(r => `<tr><td>${r.l}</td><td>${r.v.toLocaleString()}</td></tr>`).join('');
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('barChart'), { type: 'bar', data: { labels: res.map(x=>x.l), datasets: [{data: res.map(x=>x.v), backgroundColor: '#002f5d'}]}, options: {indexAxis:'y', plugins:{legend:{display:false}}}});
    }
}

// Search & Radius
document.getElementById('address-search').oninput = function() {
    const q = this.value.toLowerCase(), sug = document.getElementById('suggestions'); sug.innerHTML = '';
    if (q.length < 3) return;
    allA.filter(f => f.properties.Street_Address.toLowerCase().includes(q)).slice(0, 5).forEach(f => {
        const li = document.createElement('li'); li.innerText = f.properties.Street_Address;
        li.onclick = () => {
            const ll = [f.geometry.coordinates[1], f.geometry.coordinates[0]]; map.setView(ll, 16);
            if (marker) map.removeLayer(marker); 
            marker = L.circleMarker(ll, {color:'red'}).addTo(map).bindPopup(`<b>${f.properties.Street_Address}</b><br>Miles: <input id="rv" type="number" value="0.5" step="0.1"><button onclick="goR(${ll[0]},${ll[1]})">Go</button>`).openPopup();
            sug.innerHTML = '';
        };
        sug.appendChild(li);
    });
};

function goR(lat, lng) {
    const m = document.getElementById('rv').value; 
    shape = turf.circle([lng, lat], m * 1.609, {units:'kilometers'});
    drawnItems.clearLayers(); L.geoJSON(shape).addTo(drawnItems); update(); map.closePopup();
}

// UI Controls
document.getElementById('cat-sel').onchange = (e) => {
    const t = document.getElementById('tab-sel'); t.innerHTML = '<option value="">-- Table --</option>';
    if (e.target.value) Object.keys(mapping[e.target.value].t).forEach(k => t.innerHTML += `<option value="${k}">${k}</option>`);
};
document.getElementById('tab-sel').onchange = async (e) => {
    const c = document.getElementById('cat-sel').value;
    csvData = await load(`${mapping[c].f}/${mapping[c].t[e.target.value]}`); update();
};

const draw = new L.Control.Draw({draw: {polyline:false, marker:false, circlemarker:false}}); map.addControl(draw);
map.on('draw:created', e => { drawnItems.clearLayers(); drawnItems.addLayer(e.layer); shape = e.layer.toGeoJSON(); update(); });

L.control({position:'topright'}).onAdd = () => {
    const btn = L.DomUtil.create('button', 'leaflet-bar'); btn.innerText = 'â¤¢'; btn.style.padding = '5px';
    btn.onclick = () => { document.getElementById('map-container').classList.toggle('expanded'); document.getElementById('data-panel').classList.toggle('hidden'); setTimeout(()=>map.invalidateSize(), 400); };
    return btn;
}.addTo(map);

init();
</script>
<style> @keyframes spin { 100% { transform: rotate(360deg); } } </style>
</body>
</html>
