(async function() {
    // Initialize Map
    const map = L.map('map', { renderer: L.canvas(), preferCanvas: true }).setView([34.7304, -86.5861], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const buildingsLayer = L.layerGroup().addTo(map);
    const drawnItems = new L.FeatureGroup().addTo(map);
    let allBuildings = [];

    // Load Background Data
    try {
        const cityData = await fetch('Boundary_City_Huntsville_poly.geojson').then(res => res.json());
        L.geoJSON(cityData, { style: { color: 'orange', weight: 2, fillOpacity: 0.3, interactive: false } }).addTo(map);

        const bgData = await fetch('Huntsville_Block_Groups.geojson').then(res => res.json());
        L.geoJSON(bgData, { style: { color: 'black', weight: 1, fillOpacity: 0, interactive: false } }).addTo(map);

        const files = [
            'Buildings_Residential_Zones_part1.geojson',
            'Buildings_Residential_Zones_part2.geojson',
            'Buildings_Residential_Zones_part3.geojson',
            'Buildings_Residential_Zones_part4.geojson'
        ];

        for (const f of files) {
            const data = await fetch(f).then(res => res.json());
            allBuildings = allBuildings.concat(data.features);
        }

    } catch (e) { 
        console.error("Error loading GeoJSON files:", e);
    }

    // Function to search buildings inside drawn shapes
    function runBuildingSearch(filterShape) {
        buildingsLayer.clearLayers();

        const searchBbox = turf.bboxPolygon(turf.bbox(filterShape));
        const results = allBuildings.filter(building => {
            const bBox = turf.bboxPolygon(turf.bbox(building));
            if (!turf.booleanIntersects(searchBbox, bBox)) return false;
            return turf.booleanIntersects(building, filterShape);
        });

        document.getElementById('count-display').innerText = results.length.toLocaleString();

        if (results.length > 0) {
            L.geoJSON(results, {
                style: { color: '#00b894', weight: 1, fillOpacity: 0.6 }, // âœ… All green
                interactive: false
            }).addTo(buildingsLayer);
        }
    }

    // Drawing Tools (only draw, no edit/delete buttons)
    const drawControl = new L.Control.Draw({
        draw: { 
            polyline: false, 
            marker: false, 
            circlemarker: false, 
            polygon: true, 
            rectangle: true, 
            circle: true 
        },
        edit: false
    });
    map.addControl(drawControl);

    map.on('draw:created', function(e) {
        drawnItems.clearLayers();
        const layer = e.layer;
        drawnItems.addLayer(layer);

        let geoJSON;
        if (layer instanceof L.Circle) {
            const center = layer.getLatLng();
            const radiusKms = layer.getRadius() / 1000;
            geoJSON = turf.circle([center.lng, center.lat], radiusKms, { units: 'kilometers' });
        } else {
            geoJSON = layer.toGeoJSON();
        }

        runBuildingSearch(geoJSON);
    });

    // Manual Reset Button (Broom)
    const cleaner = L.control({position: 'topright'});
    cleaner.onAdd = () => {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = '<a href="#" style="background:white;width:34px;height:34px;display:flex;align-items:center;justify-content:center;text-decoration:none;">ðŸ§¹</a>';
        div.onclick = (e) => {
            e.preventDefault();
            buildingsLayer.clearLayers();
            drawnItems.clearLayers();
            document.getElementById('count-display').innerText = "0";
        };
        return div;
    };
    cleaner.addTo(map);

})();
